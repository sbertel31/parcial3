name: Enhanced Security Scan Workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '39 20 * * 1'

env:
  IMAGE_NAME: "node:14"
  DOCKERFILE: "Dockerfile"
  SCAN_TOOL: "snyk"  # o "style" segÃºn tu herramienta

permissions:
  contents: read
  security-events: write
  actions: read
  id-token: write

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq docker.io
          npm install -g $SCAN_TOOL

      - name: Build Docker image
        run: docker build -t $IMAGE_NAME -f $DOCKERFILE .

      - name: Authenticate with scan tool
        run: |
          if [ "$SCAN_TOOL" = "snyk" ]; then
            snyk auth ${{ secrets.SNYK_TOKEN }}
          else
            echo "Implement Style authentication here"
            # style auth ${{ secrets.STYLE_TOKEN }}
          fi

      - name: Run security scan and fix SARIF format
        run: |
          if [ "$SCAN_TOOL" = "snyk" ]; then
            snyk container test $IMAGE_NAME --file=$DOCKERFILE --severity-threshold=medium --sarif-file-output=scan_results.sarif || true
          else
            # Comando equivalente para Style si es diferente
            style scan container $IMAGE_NAME --output=scan_results.sarif || true
          fi
          
          # Corregir formato SARIF
          jq '
            .runs[].results[] |= (
              if .level == null then .level = "warning" else . end |
              if .locations[].physicalLocation.region.startLine == null then del(.locations[].physicalLocation.region.startLine) else . end
            )' scan_results.sarif > fixed_results.sarif

      - name: Validate SARIF file
        run: |
          if [ ! -s fixed_results.sarif ]; then
            echo "Error: SARIF file is empty or missing"
            exit 1
          fi
          
          if jq -e '.runs[].results[] | select(.level == null)' fixed_results.sarif; then
            echo "Error: Still found results with null severity"
            exit 1
          fi

      - name: Upload results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: fixed_results.sarif
          checkout_path: ${{ github.workspace }}

      - name: Post-scan cleanup
        run: |
          docker rmi $IMAGE_NAME || true
          rm -f scan_results.sarif fixed_results.sarif
