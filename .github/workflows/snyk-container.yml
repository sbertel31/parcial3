name: Container Vulnerability Audit

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '18 9 * * 3'  # Todos los miércoles a las 09:18 UTC

permissions:
  contents: read
  security-events: write

jobs:
  container-scan:
    name: Run Snyk Scan on Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Obtener el código fuente
        uses: actions/checkout@v4

      - name: Construir imagen Docker para análisis
        run: docker build -t audited-image .

      - name: Instalar CLI de Snyk
        run: npm install -g snyk

      - name: Ejecutar análisis de contenedor con Snyk
        id: container-scan
        continue-on-error: true
        run: |
          snyk container test audited-image \
            --file=Dockerfile \
            --sarif > report.sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Validar archivo SARIF generado
        run: |
          if [ -f "report.sarif" ]; then
            echo "Archivo SARIF encontrado. Corrigiendo posibles campos nulos..."
            sed -i 's/"securitySeverity": null/"securitySeverity": "medium"/g' report.sarif
          else
            echo "Archivo SARIF no encontrado. Abortando."
            exit 1
          fi

      - name: Publicar resultados en GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: report.sarif
