name: Enhanced Container Security Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '39 20 * * 1'  # EjecuciÃ³n semanal cada lunes a las 20:39

env:
  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  IMAGE_NAME: "ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ github.sha }}"
  DOCKERFILE: "Dockerfile"
  NODE_VERSION: "20.9.0"

permissions:
  contents: read
  security-events: write
  packages: write
  id-token: write

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm install -g snyk docker jq

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image (Node.js ${{ env.NODE_VERSION }})
        run: |
          docker build -t $IMAGE_NAME \
            --build-arg NODE_VERSION=$NODE_VERSION \
            -f $DOCKERFILE .
          docker tag $IMAGE_NAME ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest

      - name: Authenticate with Snyk
        run: snyk auth $SNYK_TOKEN

      - name: Run Snyk container scan
        run: |
          snyk container test $IMAGE_NAME \
            --file=$DOCKERFILE \
            --severity-threshold=medium \
            --exclude-base-image-vulns \
            --sarif-file-output=snyk.sarif
        continue-on-error: true

      - name: Process SARIF results
        if: always()
        run: |
          if [ -f snyk.sarif ]; then
            echo "Processing SARIF..."
            jq '
              .runs[].results[] |= (
                if .level == null then .level = "warning" else . end |
                if .locations[].physicalLocation.region.startLine == null then del(.locations[].physicalLocation.region.startLine) else . end
              )' snyk.sarif > processed-snyk.sarif
          else
            echo "SARIF not generated."
          fi

      - name: Prepare SARIF for upload
        if: always()
        run: |
          if [ -f processed-snyk.sarif ]; then
            cp processed-snyk.sarif upload.sarif
          else
            echo "{}" > upload.sarif
          fi

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: upload.sarif
          checkout_path: ${{ github.workspace }}

      - name: Push Docker image to GHCR
        run: |
          docker push $IMAGE_NAME
          docker push ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest

      - name: Verify container health
        run: |
          docker run -d --name test-container -p 3000:3000 $IMAGE_NAME
          sleep 10
          curl -s http://localhost:3000 || echo "Health check failed"
          docker stop test-container
          docker rm test-container
